services:
  collectarr:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: collectarr-dev
    restart: "no"
    ports:
      - "${PORT:-7795}:7795"
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - PORT=7795
      - HOST=0.0.0.0
      - DATABASE_URL=file:/app/data/dev.db
      # Secrets auto-generated on first run if not provided
      - JWT_SECRET=${JWT_SECRET:-}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
      - MDBLIST_API_KEY=${MDBLIST_API_KEY:-}
      - TMDB_API_KEY=${TMDB_API_KEY:-}
      - TRAKT_CLIENT_ID=${TRAKT_CLIENT_ID:-}
      - TRAKT_CLIENT_SECRET=${TRAKT_CLIENT_SECRET:-}
      - TRAKT_REDIRECT_URI=${TRAKT_REDIRECT_URI:-http://localhost:7795/api/v1/auth/trakt/callback}
    volumes:
      - ./src:/app/src:ro
      - ./client:/app/client:ro
      - ./prisma:/app/prisma
      - collectarr-dev-data:/app/data
      - collectarr-dev-modules:/app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7795/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  collectarr-dev-data:
    name: collectarr-dev-data
  collectarr-dev-modules:
    name: collectarr-dev-modules
