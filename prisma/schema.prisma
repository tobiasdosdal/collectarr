generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  apiKey            String    @unique @default(uuid())
  isAdmin           Boolean   @default(false)
  traktAccessToken  String?
  traktRefreshToken String?
  traktExpiresAt    DateTime?
  mdblistApiKey     String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  collections   Collection[]
  embyServers   EmbyServer[]
  radarrServers RadarrServer[]
  sonarrServers SonarrServer[]
  syncLogs      SyncLog[]

  @@index([apiKey])
  @@index([isAdmin])
}

model Collection {
  id           String   @id @default(uuid())
  userId       String
  name         String
  description  String?
  sourceType   String
  sourceId     String?
  sourceUrl    String?
  posterPath   String?
  isEnabled    Boolean  @default(true)
  syncInterval Int      @default(24)
  lastSyncAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CollectionItem[]
  syncLogs SyncLog[]

  @@unique([userId, sourceType, sourceId])
}

model CollectionItem {
  id           String   @id @default(uuid())
  collectionId String
  mediaType    String
  title        String
  year         Int?
  imdbId       String?
  tmdbId       String?
  traktId      String?
  tvdbId       String?
  posterPath   String?
  backdropPath String?
  rating       Float?
  ratingCount  Int?
  inEmby       Boolean  @default(false)
  embyItemId   String?
  addedAt      DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, tmdbId])
  @@index([imdbId])
  @@index([tmdbId])
  @@index([tvdbId])
  @@index([inEmby])
  @@index([collectionId, inEmby])
  @@index([collectionId, addedAt])
  @@index([tmdbId, imdbId])
}

model EmbyServer {
  id        String   @id @default(uuid())
  userId    String
  name      String
  url       String
  apiKey    String
  apiKeyIv String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  syncLogs SyncLog[]

  @@unique([userId, url])
  @@index([userId, isDefault])
}

model SyncLog {
  id            String   @id @default(uuid())
  userId        String
  embyServerId  String?
  collectionId  String?
  status        String
  itemsTotal    Int      @default(0)
  itemsMatched  Int      @default(0)
  itemsFailed   Int      @default(0)
  errorMessage  String?
  details       String?
  startedAt     DateTime @default(now())
  completedAt   DateTime?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  embyServer EmbyServer? @relation(fields: [embyServerId], references: [id], onDelete: Cascade)
  collection Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([status, startedAt])
}

model RadarrServer {
  id               String   @id @default(uuid())
  userId           String
  name             String
  url              String
  apiKey           String
  apiKeyIv         String?
  isDefault        Boolean  @default(false)
  qualityProfileId Int?
  rootFolderPath   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
  @@index([userId])
}

model SonarrServer {
  id               String   @id @default(uuid())
  userId           String
  name             String
  url              String
  apiKey           String
  apiKeyIv         String?
  isDefault        Boolean  @default(false)
  qualityProfileId Int?
  rootFolderPath   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
  @@index([userId])
}
