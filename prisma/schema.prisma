generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  apiKey       String    @unique @default(uuid())
  isAdmin      Boolean   @default(false)
  onboardingCompleted Boolean @default(false)
  onboardingDismissedAt DateTime?
  onboardingSteps String?  // JSON string storing step completion status
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  syncLogs SyncLog[]

  @@index([apiKey])
  @@index([isAdmin])
}

model Settings {
  id                String    @id @default("singleton")
  traktAccessToken  String?
  traktRefreshToken String?
  traktExpiresAt    DateTime?
  mdblistApiKey     String?
  tmdbApiKey        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Collection {
  id           String    @id @default(uuid())
  name         String
  description  String?
  sourceType   String
  sourceId     String?
  sourceUrl    String?
  posterPath   String?
  isEnabled    Boolean   @default(true)
  refreshIntervalHours Int       @default(24)
  refreshTime          String?   // Preferred refresh time in HH:MM format (24-hour)
  syncToEmbyOnRefresh    Boolean   @default(true)
  removeFromEmby         Boolean   @default(true)
  deleteFromEmbyOnDelete Boolean   @default(false)
  lastSyncAt             DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  items        CollectionItem[]
  syncLogs     SyncLog[]
  embyServers  CollectionEmbyServer[]

  @@unique([sourceType, sourceId])
}

model CollectionItem {
  id           String   @id @default(uuid())
  collectionId String
  mediaType    String
  title        String
  year         Int?
  imdbId       String?
  tmdbId       String?
  traktId      String?
  tvdbId       String?
  posterPath   String?
  backdropPath String?
  rating       Float?
  ratingCount  Int?
  inEmby       Boolean  @default(false)
  embyItemId   String?
  addedAt      DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, tmdbId])
  @@index([imdbId])
  @@index([tmdbId])
  @@index([tvdbId])
  @@index([inEmby])
  @@index([collectionId, inEmby])
  @@index([collectionId, addedAt])
  @@index([tmdbId, imdbId])
}

model EmbyServer {
  id        String   @id @default(uuid())
  name      String
  url       String   @unique
  apiKey    String
  apiKeyIv  String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  syncLogs     SyncLog[]
  collections CollectionEmbyServer[]

  @@index([isDefault])
}

model CollectionEmbyServer {
  collectionId String
  embyServerId String
  createdAt    DateTime @default(now())

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  embyServer EmbyServer @relation(fields: [embyServerId], references: [id], onDelete: Cascade)

  @@id([collectionId, embyServerId])
  @@index([embyServerId])
}

model SyncLog {
  id           String    @id @default(uuid())
  userId       String?
  embyServerId String?
  collectionId String?
  status       String
  itemsTotal   Int       @default(0)
  itemsMatched Int       @default(0)
  itemsFailed  Int       @default(0)
  errorMessage String?
  details      String?
  startedAt    DateTime  @default(now())
  completedAt  DateTime?

  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  embyServer EmbyServer? @relation(fields: [embyServerId], references: [id], onDelete: Cascade)
  collection Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
  @@index([startedAt])
  @@index([status, startedAt])
}

model RadarrServer {
  id               String   @id @default(uuid())
  name             String
  url              String   @unique
  apiKey           String
  apiKeyIv         String?
  isDefault        Boolean  @default(false)
  qualityProfileId Int?
  rootFolderPath   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SonarrServer {
  id               String   @id @default(uuid())
  name             String
  url              String   @unique
  apiKey           String
  apiKeyIv         String?
  isDefault        Boolean  @default(false)
  qualityProfileId Int?
  rootFolderPath   String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
